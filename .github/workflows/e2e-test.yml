name: e2e-test

on:
  push:

jobs:
  test:
    strategy:
      matrix:
        include:
          # "selenium/standalone-${e2e_docker_image_fragment}"
          # Why fragment? These short names are more readable in GitHub UI
          - e2e_docker_image_fragment: chrome:108.0
          - e2e_docker_image_fragment: chrome:84.0
          - e2e_docker_image_fragment: firefox:107.0
          - e2e_docker_image_fragment: firefox:78.0
          - e2e_docker_image_fragment: firefox:107.0
            e2e_service_worker_disable: true
          - e2e_docker_image_fragment: firefox:78.0
            e2e_service_worker_disable: true

    runs-on: ubuntu-20.04
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16.x
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            e2e-test/package-lock.json
      - name: Install dependencies
        run: |
          set -eu
          npm ci &
          (cd e2e-test && npm ci) &
          wait
      - run: PORT=4000 npm run serve &
      - name: Wait for serving
        run: |
          set -eu
          while true
          do
            if [ "$(curl -s -o /dev/null -w "%{http_code}" http://localhost:4000)" -eq 200 ]
            then
              break
            fi
            sleep 1
          done
        timeout-minutes: 3
      - name: E2E test (${{ matrix.e2e_docker_image_fragment }})
        run: cd e2e-test && E2E_DOCKER_IMAGE=selenium/standalone-${{ matrix.e2e_docker_image_fragment }} E2E_DISABLE_SERVICE_WORKER=${{ matrix.e2e_service_worker_disable }} npm start
